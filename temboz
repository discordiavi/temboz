#!/usr/bin/env python
import sys

# XXX TODO
# XXX pacing

def usage():
  print """usage: %s [options]
  --refresh            : refresh the subscribed feeds
  --import <opml_file> : import subscriptions from a OPML file
  --server             : run the built-in web server
  --kill               : kill the server
  -v                   : be more verbose (can be repeated)
  -h, --help           : print this help text
  """ % sys.argv[0]
  sys.exit(0)

if __name__ == '__main__':
  import getopt
  opts, args = getopt.getopt(sys.argv[1:], 'vh',
                             ['refresh', 'server', 'import=', 'kill', 'help'])
  if opts == []:
    usage()
  for opt, val in opts:
    if opt in ['-h', '--help']:
      usage()
    if opt == '--refresh':
      import update
      update.update()
    elif opt == '--import':
      import opml
      opml.import_opml(val)
    elif opt == '--server':
      import update, server
      # close stdin file descriptor
      try:
        import posix
        posix.close(0)
        posix.open('/dev/null', posix.O_RDONLY)
      except ImportError:
        pass
      updater = update.PeriodicUpdater()
      updater.start()
      server.run()
    elif opt == '--kill':
      import os
      pid = int(open('temboz.pid').readline().strip())
      os.kill(pid, 9)
      os.remove('temboz.pid')
      

## -*- html -*-
#from singleton import db
#import time
#import param

#set public = False
#if $getVar('show', 'unread') == 'up':
#set item_desc = 'interesting'
#set where_clause = 'item_rating > 0'
#elif $getVar('show', 'unread') == 'mylos':
#set public = True
#set item_desc = 'interesting'
#set where_clause = 'item_rating > 0'
#elif $getVar('show', 'unread') == 'down':
#set item_desc = 'uninteresting'
#set where_clause = 'item_rating = -1'
#elif $getVar('show', 'unread') == 'filtered':
#set item_desc = 'filtered'
#set where_clause = 'item_rating = -2'
#elif $getVar('show', 'unread') == 'all':
#set item_desc = 'all'
#set where_clause = 'item_rating is not null'
#else:
#set item_desc = 'unread'
#set where_clause = 'item_rating = 0'
#end if

#if $getVar('feed_uid', None):
#set where_clause = where_clause + ' and item_feed_uid=' + $feed_uid
#end if

#if not $getVar('offset', None):
#set offset = '0'
#end if
#set offset = int(offset)

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Temboz - $item_desc items</title>
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
<script language="JavaScript">
hidden = Array();
#if public:
#set img_prefix = 'images'
function webop(op, uid) {
  ; // don't do anything about up/down yet
}
#else:
#set img_prefix = ''
var i = new Image();
function webop(op, uid) {
  i.src = '/feedback/' + op + '/' + Math.random().toString().substring(8) + '/' + uid + '.gif';
}
#end if
function hide(id) {
  elt = document.getElementById('art' + id);
  if(elt.style.backgroundColor == "yellow") {
    elt.style.backgroundColor = "";
    webop('basic', id);
  } else {
    hidden[hidden.length] = elt;
    elt.style.display = "none";
    webop('demote', id);
  }
}
function highlight(id) {
  elt = document.getElementById('art' + id);
  elt.style.backgroundColor = "yellow";
  webop('promote', id);
}
function unhide_all() {
  for(i=0; i<hidden.length; i++) {
    elt = hidden[i];
    elt.style.display = "block";
    webop('basic', elt.id.substring(3));
  }
  hidden = Array();
}
function unhide_last() {
  if(hidden.length > 0) {
    elt = hidden[hidden.length - 1];
    elt.style.display = "block";
    webop('basic', elt.id.substring(3));
    hidden.length = hidden.length - 1
  }
}
function toggle(item)
{
	document.items[item].checked = !document.items[item].checked;
}
</script>
#if public:
<link rel="stylesheet" type="text/css" href="gems/temboz.css">

<p class="menu">This page is produced automatically from my RSS aggregator, <a
href="http://www.temboz.com/">Temboz</a>. It shows the last 200 articles from
the feeds in blogroll I found interesting. Clicking the "thumbs up" icons will
highlight the article, clicking "thumbs down" will make it disappear (or
cancel the highlight if highlighted).</p>

#else:
<link rel="stylesheet" type="text/css" href="temboz.css">
#end if
<style type="text/css">
</style>
</head>
<body>
#set c = db.cursor()
#silent c.execute("""update fm_items set item_viewed=julianday('now') where item_uid in (select item_uid from fm_items where """ + where_clause + """
order by item_created DESC, item_uid DESC
limit %d offset %d)""" % (param.overload_threshold, offset))
#silent c.execute("""select count(*) from fm_items where """ + where_clause)
#set num_items = int(c.fetchone()[0])
#set cutoff = (num_items + 1) / 2 + 1
#set count = 0
<p class="menu">$num_items $item_desc items
#if num_items > param.overload_threshold:
($param.overload_threshold shown)
#set cutoff = (param.overload_threshold + 1) / 2 + 1
#end if
&nbsp;&nbsp;<a href="javascript:unhide_all();">Unhide all</a>&nbsp;&nbsp;<a href="javascript:unhide_last();">Unhide last</a>
#if public:
</p>
#else:
&nbsp;&nbsp;<a href="/feeds/">All feeds</a>&nbsp;&nbsp;<a href="/add/">Add feed</a></p>
#end if
#silent c.execute("""select item_uid, item_creator, item_title, item_link,
item_content, datetime(item_loaded), date(item_created),
feed_title, feed_html, feed_xml, julianday('now') - julianday(item_created)
from fm_items, fm_feeds where item_feed_uid=feed_uid
and """ + where_clause + """ order by item_created DESC, item_uid DESC
limit %d""" % param.overload_threshold)
<div class="col1">
#for uid, creator, title, link, content, loaded, created, feed_title, feed_html, feed_xml, delta_created in c:
#set count += 1
#if count == cutoff:
</div><div class="col2">
#end if
#if public:
#set redirect = link
#else:
#set redirect = '/redirect/' + `uid`
#end if
#set since_when = self.since(delta_created)
<div class="article" id="art$uid"><div class="headline"><img width="32" height="32" alt="up" src="<%=img_prefix%>/up.gif" class="up" onclick="highlight('$uid')" /><img width="32" height="32" alt="down" src="<%=img_prefix%>/down.gif" class="down" onclick="hide('$uid')" /><a href="<%=$redirect%>" class="headline" target="_blank" onclick="highlight('$uid');">$title</a><br><a href="$feed_html" title="" class="source">$feed_title</a> - $since_when<br><!-- by $creator, cached at $loaded --></div><div class="content">$content</div></div>
#end for
</div>
#silent db.commit()
#silent c.close()

<div style="clear: both;" />
</body></html>
